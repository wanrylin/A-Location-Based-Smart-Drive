<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IOT project v1</title>
    <link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" type="text/css" />

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <style>
        body {
            margin: 0; /* 移除默认的 margin */
            height: 100vh; /* 使 body 的高度填满整个视口高度 */
            display: flex;
            flex-direction: column; /* 使子元素垂直排列 */
            justify-content: center; /* 垂直居中 */
            align-items: center; /* 水平方向靠右对齐 */
        }

        /* Add a container for the text and the dropzone */
        .content-container {
            display: flex;
            width: 100%; /* Take the full width of the viewport */
        }

        /* Style for the text container */
        .text-container {
            width: 40%; /* Allocate width for the text container */
            padding: 20px; /* Add some padding around the text */
            text-align: left; /* Align the text to the left */
            margin-right: 100px;
        }

        .dropzone {
            width: 600px; /* 设置宽度 */
            height: 400px; /* 设置高度 */
            border: 2px dashed #0087F7;
            border-radius: 5px;
            background: white;
            display: flex;
            justify-content: center; /* 水平居中文本 */
            align-items: center; /* 垂直居中文本 */
            text-align: center; /* 确保文本居中对齐 */
            font-size: 16px; /* 文本大小 */
            color: #333; /* 文本颜色 */
            margin-bottom: 10px; /* 在下方添加一些空间 */
        }

        #mapid { height: 400px; width: 100%;} /* Adjust the width as needed */
        #progressBarContainer {
            width: 100%; /* Adjust the width as needed */
            background-color: #ddd;
        }

        #progressBar {
            width: 1%;
            height: 30px;
            background-color: #4CAF50;
        }

    </style>
</head>
<body>

<div class="content-container">
    <!-- Container for the text and map -->
    <div class="text-container">
        <h1>Your Current Location</h1>
        <p><span id="address"></span></p>
        <div id="progressBarContainer">
            <div id="progressBar"></div>
        </div>
        <div id="mapid"></div>
    </div>

    <!-- Container for the dropzone -->
    <div class="dropzone-container">
        <div class="dropzone" id="my-awesome-dropzone"></div>
        <p id="file-path"></p>
    </div>
</div>

<!-- ... DropzoneJS code ... -->
<!-- 这是备选的文件选择输入 -->
<input type="file" id="fileInput" name="file" style="display: none;" />

<!-- 先加载 DropzoneJS -->
<script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
<script>
    // 禁用 Dropzone 的自动发现功能
    Dropzone.autoDiscover = false;

    // 初始化 Dropzone
    var myDropzone = new Dropzone("#my-awesome-dropzone", {
        url: "/file-upload",
        paramName: "file",
        maxFilesize: 2,
        acceptedFiles: "image/*,application/pdf,.psd",
        dictDefaultMessage: "Drag and drop files here or click to upload", // 自定义消息
        sending: function(file, xhr, formData) {
            // 附加地址数据到请求中
            formData.append('address', document.getElementById('address').textContent);
        }
    });

    // Add an event listener for when a file is successfully uploaded
    myDropzone.on("success", function(file, response) {
        // 'response' is the JSON data from the server
        console.log(response.message); // Message from the server
        console.log(response.file_path); // The path to the uploaded file

        // Display the file path in an HTML element
        var pathElement = document.getElementById('file-path');
        if(pathElement) {
            pathElement.textContent = 'File is saved at: ' + response.file_path;
        }
    });


</script>

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<!-- ... Location and map initialization script ... -->
<script>
    var progress = 0; // Initialize progress at 0

    // Function to update the progress bar
    function updateProgress(step) {
        progress += step;
        document.getElementById('progressBar').style.width = progress + '%';
        if (progress >= 100) {
            // Hide the progress bar when the process is complete
            document.getElementById('progressBarContainer').style.display = 'none';
        }
    }

    // Function to start the progress update interval
    function startProgress() {
        progressInterval = setInterval(function() {
            updateProgress(5);
        }, 1000); // Update progress every 1000 milliseconds (1 second)
    }

    // Get the detailed address of the location
    function getOSMAddress(latitude, longitude) {
        var url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log(data.display_name); // This is the detailed address

                // Set the detailed address to the page element
                document.getElementById('address').textContent = data.display_name;

                // Now send this data back to the server
                fetch('/location-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ address: data.display_name })
                })
                    .then(response => {
                        if (response.ok) {
                            console.log('Location data was successfully sent to the server.');
                        }
                        return response.text();
                    })
                    .then(text => console.log(text))
                    .catch(error => console.error('Error:', error));
            })
            .catch(error => console.error(error));
    }


    // Function to initialize the map
    function initMap(latitude, longitude) {
        // Set progress to 50% once we have the location
        updateProgress(40);
        // Show the address
        getOSMAddress(latitude, longitude);
        // Create a map in the "mapid" div after a short delay to simulate processing time
        setTimeout(function() {
            var map = L.map('mapid').setView([latitude, longitude], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            var marker = L.marker([latitude, longitude]).addTo(map);
            //marker.bindPopup("<b>You are here!</b>").openPopup();

            // Set progress to 100% once the map is loaded
            updateProgress(50);
        }, 500); // Simulate a delay for loading the map
    }

    // Function to get the current position
    function getLocation() {
        if (navigator.geolocation) {
            // Set progress to 10% to indicate that the process has started
            startProgress();

            navigator.geolocation.getCurrentPosition(function(position) {
                var latitude = position.coords.latitude;
                var longitude = position.coords.longitude;
                initMap(latitude, longitude);
            }, function(error) {
                alert("Error occurred. Error code: " + error.code);
                // Set progress to 100% as the process ends even if it failed
                updateProgress(100 - progress);
            });
        } else {
            alert("Geolocation is not supported by this browser.");
            // Set progress to 100% as the process ends if not supported
            updateProgress(100);
        }
    }
    // Call getLocation function to get the current position
    getLocation();
</script>

</body>
</html>
